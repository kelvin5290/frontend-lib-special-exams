{"version":3,"file":"TimerProvider.js","names":["_react","_interopRequireWildcard","require","_reactRedux","_propTypes","_interopRequireDefault","_data","_events","_jsxRuntime","obj","__esModule","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_typeof","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_slicedToArray","arr","i","_arrayWithHoles","_iterableToArrayLimit","_unsupportedIterableToArray","_nonIterableRest","TypeError","o","minLen","_arrayLikeToArray","n","toString","slice","constructor","name","Array","from","test","len","length","arr2","r","l","t","Symbol","iterator","e","u","a","f","next","done","push","value","isArray","GRACE_PERIOD_SECS","POLL_INTERVAL","TIME_LIMIT_CRITICAL_PCT","TIME_LIMIT_LOW_PCT","LIMIT","TimerContext","exports","React","createContext","getFormattedRemainingTime","timeLeft","hours","Math","floor","minutes","seconds","TimerProvider","_ref","children","_useSelector","useSelector","state","specialExams","attempt","activeAttempt","exam","_useState","useState","_useState2","timeState","setTimeState","lastSignal","useRef","dispatch","useDispatch","timeLimitMins","time_limit_mins","workerUrl","desktop_application_js_url","pingInterval","ping_interval","timerEnds","timer_ends","getTimeString","values","map","item","concat","join","pollExam","useCallback","pollAttempt","exam_started_poll_url","processTimeLeft","secondsLeft","emit","signal","current","Emitter","criticalLowTime","lowTime","TIMER_LIMIT_REACHED","TIMER_REACHED_NULL","TIMER_IS_CRITICALLY_LOW","TIMER_IS_LOW","deadline","Date","useEffect","timerRef","timerTick","ticker","now","remainingTime","getTime","pingAttempt","killTimer","clearInterval","setTimeout","setInterval","jsx","Provider","propTypes","PropTypes","element","isRequired","_default"],"sources":["../../src/timer/TimerProvider.jsx"],"sourcesContent":["import React, {\n  useEffect, useState, useCallback, useRef,\n} from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport PropTypes from 'prop-types';\nimport { Emitter, pollAttempt, pingAttempt } from '../data';\nimport {\n  TIMER_IS_CRITICALLY_LOW,\n  TIMER_IS_LOW,\n  TIMER_LIMIT_REACHED,\n  TIMER_REACHED_NULL,\n} from './events';\n\n// Give an extra 5 seconds where the timer holds at 00:00 before page refreshes\nconst GRACE_PERIOD_SECS = 5;\nconst POLL_INTERVAL = 60;\nconst TIME_LIMIT_CRITICAL_PCT = 0.05;\nconst TIME_LIMIT_LOW_PCT = 0.2;\nconst LIMIT = GRACE_PERIOD_SECS ? 0 - GRACE_PERIOD_SECS : 0;\n\nexport const TimerContext = React.createContext({});\n\nconst getFormattedRemainingTime = (timeLeft) => ({\n  hours: Math.floor(timeLeft / (60 * 60)),\n  minutes: Math.floor((timeLeft / 60) % 60),\n  seconds: Math.floor(timeLeft % 60),\n});\n\nconst TimerProvider = ({\n  children,\n}) => {\n  const { activeAttempt: attempt, exam } = useSelector(state => state.specialExams);\n  const [timeState, setTimeState] = useState({});\n  const lastSignal = useRef(null);\n  const dispatch = useDispatch();\n  const { time_limit_mins: timeLimitMins } = exam;\n  const {\n    desktop_application_js_url: workerUrl,\n    ping_interval: pingInterval,\n    timer_ends: timerEnds,\n  } = attempt;\n\n  const getTimeString = () => Object.values(timeState).map(\n    item => {\n      // Do not show timer negative value.\n      // User will see 00:00:00 during grace period if any.\n      const value = item < 0 ? 0 : item;\n      return (value < 10 ? `0${value}` : value);\n    },\n  ).join(':');\n\n  const pollExam = useCallback(() => {\n    // Poll url may be null if this is an LTI exam.\n    dispatch(pollAttempt(attempt.exam_started_poll_url));\n  }, [attempt.exam_started_poll_url, dispatch]);\n\n  const processTimeLeft = useCallback((secondsLeft) => {\n    const emit = (signal) => {\n      // This prevents spamming.\n      if (lastSignal.current === signal) {\n        return;\n      }\n      Emitter.emit(signal);\n      lastSignal.current = signal;\n    };\n\n    const criticalLowTime = timeLimitMins * 60 * TIME_LIMIT_CRITICAL_PCT;\n    const lowTime = timeLimitMins * 60 * TIME_LIMIT_LOW_PCT;\n\n    if (secondsLeft <= LIMIT) {\n      emit(TIMER_LIMIT_REACHED);\n      return true; // Kill the timer.\n    }\n\n    if (secondsLeft <= 0) {\n      // Used to hide continue exam button on submit exam pages.\n      // Since TIME_LIMIT_REACHED is fired after the grace period we\n      // need to emit separate event when timer reaches 00:00\n      emit(TIMER_REACHED_NULL);\n      return false;\n    }\n\n    if (secondsLeft <= criticalLowTime) {\n      emit(TIMER_IS_CRITICALLY_LOW);\n      return false;\n    }\n\n    if (secondsLeft <= lowTime) {\n      emit(TIMER_IS_LOW);\n      return false;\n    }\n\n    return false;\n  }, [\n    timeLimitMins,\n  ]);\n\n  // Set deadline as a reference to timerEnds that updates when it changes\n  const deadline = useRef(new Date(timerEnds));\n  useEffect(() => {\n    deadline.current = new Date(timerEnds);\n  }, [timerEnds]);\n\n  useEffect(() => {\n    const timerRef = { current: true };\n    let timerTick = -1;\n\n    const ticker = () => {\n      timerTick++;\n      const now = Date.now();\n      const remainingTime = (deadline.current.getTime() - now) / 1000;\n      const secondsLeft = Math.floor(remainingTime);\n\n      setTimeState(getFormattedRemainingTime(secondsLeft));\n\n      // No polling during grace period.\n      if (timerTick % POLL_INTERVAL === 0 && secondsLeft >= 0) {\n        pollExam();\n      }\n\n      // If exam is proctored ping provider app.\n      if (workerUrl && timerTick % pingInterval === pingInterval / 2) {\n        dispatch(pingAttempt(pingInterval, workerUrl));\n      }\n\n      const killTimer = processTimeLeft(secondsLeft);\n      if (killTimer) {\n        clearInterval(timerRef.current);\n        timerRef.current = null;\n      }\n    };\n\n    // We delay the first ticker execution to give time for the emmiter\n    // subscribers to hook up, otherwise immediate emissions will miss their purpose.\n    setTimeout(() => {\n      ticker();\n\n      // If the timer handler is not true at this point, it means that it was stopped in the first run.\n      // So we don't need to start the timer.\n      if (timerRef.current === true) {\n        // After the first run, we start the ticker.\n        timerRef.current = setInterval(ticker, 1000);\n      }\n    });\n\n    return () => {\n      clearInterval(timerRef.current);\n      timerRef.current = null;\n    };\n  }, [\n    pingInterval,\n    workerUrl,\n    processTimeLeft,\n    pollExam,\n    dispatch,\n  ]);\n\n  return (\n    // eslint-disable-next-line react/jsx-no-constructed-context-values\n    <TimerContext.Provider value={{\n      timeState,\n      getTimeString,\n    }}\n    >\n      {children}\n    </TimerContext.Provider>\n  );\n};\n\nTimerProvider.propTypes = {\n  children: PropTypes.element.isRequired,\n};\nexport default TimerProvider;\n"],"mappings":"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"}